generator client {
	provider = "prisma-client"
	output   = "../lib/generated/prisma"
}

datasource db {
	provider = "postgresql"
}

model User {
	id            String    @id
	name          String
	email         String    @unique
	emailVerified Boolean   @default(false)
	image         String?
	createdAt     DateTime  @default(now())
	updatedAt     DateTime  @updatedAt
	encryptedKey  String?
	keyHash       String?
	salt          String?

	sessions  Session[]
	accounts  Account[]
	vault     Vault?
	apiKeys   ApiKey[]
	auditLogs AuditLog[]

	@@map("user")
}

model Session {
	id        String   @id
	expiresAt DateTime
	token     String   @unique
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt
	ipAddress String?
	userAgent String?
	userId    String

	user User @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@map("session")
}

model Account {
	id                    String    @id
	accountId             String
	providerId            String
	userId                String
	accessToken           String?
	refreshToken          String?
	idToken               String?
	accessTokenExpiresAt  DateTime?
	refreshTokenExpiresAt DateTime?
	scope                 String?
	password              String?
	createdAt             DateTime  @default(now())
	updatedAt             DateTime  @updatedAt

	user User @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@map("account")
}

model Verification {
	id         String   @id
	identifier String
	value      String
	expiresAt  DateTime
	createdAt  DateTime @default(now())
	updatedAt  DateTime @updatedAt

	@@map("verification")
}

model Vault {
	id        String   @id @default(cuid())
	userId    String   @unique
	blobKey   String
	revision  Int      @default(0)
	size      Int      @default(0)
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
	items Item[]

	@@map("vault")
}

model Item {
	id        String   @id @default(cuid())
	vaultId   String
	type      ItemType
	title     String
	data      String
	revision  Int      @default(0)
	favorite  Boolean  @default(false)
	deleted   Boolean  @default(false)
	createdAt DateTime @default(now())
	updatedAt DateTime @updatedAt

	vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)
	tags  Tag[]

	@@index([vaultId])
	@@index([type])
	@@map("item")
}

model Tag {
	id     String @id @default(cuid())
	name   String
	itemId String

	item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)

	@@unique([itemId, name])
	@@map("tag")
}

model ApiKey {
	id        String    @id @default(cuid())
	userId    String
	keyHash   String    @unique
	hint      String
	webhook   String?
	expiresAt DateTime?
	createdAt DateTime  @default(now())
	lastUsed  DateTime?

	user User @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@index([userId])
	@@map("api_key")
}

model AuditLog {
	id        String   @id @default(cuid())
	userId    String
	action    String
	details   String?
	ip        String?
	userAgent String?
	createdAt DateTime @default(now())

	user User @relation(fields: [userId], references: [id], onDelete: Cascade)

	@@index([userId])
	@@index([action])
	@@index([createdAt])
	@@map("audit_log")
}

enum ItemType {
	login
	note
	card
	identity
	ssh
	api
	otp
	passkey
}
